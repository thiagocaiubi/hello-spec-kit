# Data Model: Pydantic Data Validation

**Feature**: 002-pydantic-validation  
**Date**: 2025-12-19  
**Phase**: 1 - Design

## Overview

This feature introduces Pydantic models for API request/response validation. The primary entity is the HealthResponse model, which formalizes the schema for the health endpoint. Additional validation error structures are provided by Pydantic's built-in ValidationError class.

## Entities

### HealthResponse

**Purpose**: Represents the health check response returned by the `/health` endpoint

**Structure**:
```python
{
  "status": "ok"
}
```

**Fields**:
- `status` (str, required): Health status indicator. Fixed value: `"ok"` for healthy state

**Constraints**:
- Response is static and immutable
- No dynamic data or calculations
- Field cannot be null or empty
- Extra fields not allowed (strict validation mode)

**Validation Rules**:
- `status` must be a string type
- `status` must be present (required field)
- Any extra fields beyond `status` will cause HTTP 422 error

**Pydantic Model Definition**:
```python
from pydantic import BaseModel, ConfigDict

class HealthResponse(BaseModel):
    model_config = ConfigDict(extra='forbid')
    status: str
```

**JSON Schema** (auto-generated by Pydantic):
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "status": {
      "type": "string",
      "title": "Status"
    }
  },
  "required": ["status"],
  "additionalProperties": false,
  "title": "HealthResponse"
}
```

---

### ValidationError (Pydantic Built-in)

**Purpose**: Represents validation errors when request or response data fails Pydantic validation

**Structure**:
```json
{
  "detail": [
    {
      "type": "string_type",
      "loc": ["body", "field_name"],
      "msg": "Input should be a valid string",
      "input": 123,
      "url": "https://errors.pydantic.dev/2/v/string_type"
    }
  ]
}
```

**Fields**:
- `detail` (array, required): List of validation errors
  - `type` (str): Error type identifier (e.g., "string_type", "missing", "extra_forbidden")
  - `loc` (array): Location of error as path array (e.g., ["body", "user", "email"])
  - `msg` (str): Human-readable error message
  - `input` (any): The invalid input value that caused the error
  - `url` (str, optional): Link to Pydantic error documentation

**Validation Rules**:
- Automatically generated by Pydantic/FastAPI
- Multiple errors can be returned simultaneously
- Nested fields show full path in `loc` array
- HTTP status code is always 422 for validation errors

**Note**: This structure is provided by FastAPI/Pydantic and does not require custom implementation.

## State Management

**Stateless**: All Pydantic models are stateless:
- No database interactions
- No in-memory state
- No session management
- Each request is independent
- Validation rules are fixed at model definition time

## Data Flow

### Request Validation Flow
```
HTTP Request → FastAPI → Pydantic Model Validation → Endpoint Handler
                              ↓ (validation fails)
                         HTTP 422 + ValidationError
```

### Response Validation Flow
```
Endpoint Handler → Return Data → Pydantic Model Serialization → HTTP Response
                                        ↓ (validation fails)
                                   FastAPI Internal Error
```

**Health Endpoint Flow**:
```
GET /health → health() function → {"status": "ok"} → HealthResponse validation → JSON response
```

## Validation Rules

### Type Coercion (Pydantic Default Behavior)

**Automatic Coercion**:
- String to int: `"123"` → `123`
- String to float: `"45.67"` → `45.67`
- String to bool: `"true"` → `True`, `"1"` → `True`, `"false"` → `False`, `"0"` → `False`
- Int to float: `42` → `42.0`

**Coercion Failures** (ValidationError raised):
- String to int: `"abc"` → Error
- String to bool: `"yes"` → Error (only true/false/1/0 accepted)
- Complex types: Cannot coerce dict to list, etc.

### Field Requirements

**Required Fields**: Must be present in request, cannot be null
```python
class Model(BaseModel):
    name: str  # Required
```

**Optional Fields**: Can be omitted, defaults to None if not provided
```python
from typing import Optional

class Model(BaseModel):
    name: Optional[str] = None  # Optional
```

**Optional with Default**: Uses default value if not provided
```python
class Model(BaseModel):
    status: str = "ok"  # Optional with default
```

### Nested Validation

Pydantic validates nested structures recursively without depth limits:

```python
class Address(BaseModel):
    street: str
    city: str

class User(BaseModel):
    name: str
    address: Address  # Nested model

# Validation path for errors: ["body", "user", "address", "city"]
```

## Type Definitions

**Python Type Hints** (all models use these):

```python
from pydantic import BaseModel, ConfigDict
from typing import Optional

# Simple model
class HealthResponse(BaseModel):
    model_config = ConfigDict(extra='forbid')
    status: str

# Future example: Optional field with default
class StatusResponse(BaseModel):
    model_config = ConfigDict(extra='forbid')
    status: str
    message: Optional[str] = None
```

## Relationships

**Current Relationships**: None - HealthResponse is independent

**Future Considerations** (out of scope for this feature):
- Request/Response pairs for new endpoints
- Nested models for complex data structures
- Shared base models for common fields

## Migration Notes

**Existing Code Impact**:
- `/health` endpoint currently returns `{"status": "ok"}` as plain dict
- After migration: returns same structure but validated through HealthResponse model
- **Zero breaking changes** - response format identical to API consumers

**Testing Impact**:
- Existing health endpoint tests continue to work
- New tests added for validation edge cases (extra fields, wrong types)

## Constraints Summary

| Model | Required Fields | Optional Fields | Extra Fields | Type Coercion |
|-------|----------------|-----------------|--------------|---------------|
| HealthResponse | status (str) | None | Forbidden | Yes (default) |

**Global Rules**:
- All models use `ConfigDict(extra='forbid')` for strict validation
- All models include type hints for all fields
- All models are immutable after creation (Pydantic default)
- All models generate JSON schema for OpenAPI documentation
